import { useNuxtApp } from "/_nuxt/@fs/D:/Bill24/b24managementportal/node_modules/nuxt/dist/app/nuxt.js?v=2fc67382";
import { useLocalStorage } from "/_nuxt/composables/useLocalStorage.ts";
import { computed, ref, watch, nextTick } from "/_nuxt/@fs/D:/Bill24/b24managementportal/node_modules/vue/dist/vue.runtime.esm-bundler.js?v=2fc67382";
import { useKeycloakGuard } from "/_nuxt/composables/useKeycloakGuard.ts";
export const useAuth = () => {
  const nuxtApp = useNuxtApp();
  const {
    getStoredKeycloakData,
    clearKeycloakData,
    getStoredToken,
    storeKeycloakData,
    updateStoredTokens
  } = useLocalStorage();
  const keycloak = computed(() => nuxtApp.$keycloak);
  const isAuthenticated = computed(() => nuxtApp.$isAuthenticated?.value ?? false);
  const isInitialized = computed(() => nuxtApp.$isKeycloakInitialized?.value ?? false);
  const initError = computed(() => nuxtApp.$keycloakInitError?.value ?? null);
  const user = ref(null);
  const token = ref(null);
  const refreshToken = ref(null);
  const initializeUserData = () => {
    const keycloakInstance = keycloak.value;
    if (keycloakInstance && keycloakInstance.authenticated) {
      user.value = getUserInfo();
      token.value = keycloakInstance.token || null;
      refreshToken.value = keycloakInstance.refreshToken || null;
      storeKeycloakData(keycloakInstance);
    } else {
      const storedData = getStoredKeycloakData();
      if (storedData && storedData.authenticated) {
        user.value = storedData.user;
        token.value = storedData.token;
        refreshToken.value = storedData.refreshToken;
      } else {
        user.value = null;
        token.value = null;
        refreshToken.value = null;
      }
    }
  };
  const login = async () => {
    const keycloakInstance = keycloak.value;
    if (!keycloakInstance) throw new Error("Keycloak not initialized");
    try {
      await keycloakInstance.login({
        redirectUri: window.location.origin
      });
    } catch (error) {
      console.error("Login failed:", error);
      throw error;
    }
  };
  const logout = async () => {
    const keycloakInstance = keycloak.value;
    if (!keycloakInstance) throw new Error("Keycloak not initialized");
    try {
      const { clearKeycloakState } = useKeycloakGuard();
      clearKeycloakState();
      clearKeycloakData();
      await keycloakInstance.logout({
        redirectUri: window.location.origin
      });
    } catch (error) {
      console.error("Logout failed:", error);
      throw error;
    }
  };
  const register = async () => {
    const keycloakInstance = keycloak.value;
    if (!keycloakInstance) throw new Error("Keycloak not initialized");
    try {
      await keycloakInstance.register({
        redirectUri: window.location.origin
      });
    } catch (error) {
      console.error("Registration failed:", error);
      throw error;
    }
  };
  const getToken = () => {
    const keycloakToken = keycloak.value?.token || null;
    if (keycloakToken) return keycloakToken;
    return getStoredToken();
  };
  const refreshAuthToken = async () => {
    const keycloakInstance = keycloak.value;
    if (!keycloakInstance) return null;
    try {
      const refreshed = await keycloakInstance.updateToken(30);
      if (refreshed) {
        token.value = keycloakInstance.token || null;
        refreshToken.value = keycloakInstance.refreshToken || null;
        const expiresAt = keycloakInstance.tokenParsed?.exp ? keycloakInstance.tokenParsed.exp * 1e3 : null;
        updateStoredTokens(
          keycloakInstance.token || null,
          keycloakInstance.refreshToken || null,
          keycloakInstance.idToken || null,
          expiresAt
        );
        console.log("Token refreshed successfully");
      }
      return keycloakInstance.token || null;
    } catch (error) {
      console.error("Token refresh failed:", error);
      clearKeycloakData();
      await logout();
      return null;
    }
  };
  const updateToken = async (minValidity = 30) => {
    const keycloakInstance = keycloak.value;
    if (!keycloakInstance) return false;
    try {
      const refreshed = await keycloakInstance.updateToken(minValidity);
      if (refreshed) {
        token.value = keycloakInstance.token || null;
        refreshToken.value = keycloakInstance.refreshToken || null;
        const expiresAt = keycloakInstance.tokenParsed?.exp ? keycloakInstance.tokenParsed.exp * 1e3 : null;
        updateStoredTokens(
          keycloakInstance.token || null,
          keycloakInstance.refreshToken || null,
          keycloakInstance.idToken || null,
          expiresAt
        );
      }
      return refreshed;
    } catch (error) {
      console.error("Failed to update token:", error);
      clearKeycloakData();
      return false;
    }
  };
  const isTokenExpired = () => {
    const keycloakInstance = keycloak.value;
    if (!keycloakInstance || !keycloakInstance.token) return true;
    return keycloakInstance.isTokenExpired();
  };
  const getUserInfo = () => {
    const keycloakInstance = keycloak.value;
    if (!keycloakInstance?.tokenParsed) return null;
    const tokenParsed = keycloakInstance.tokenParsed;
    return {
      id: tokenParsed.sub || "",
      username: tokenParsed.preferred_username || "",
      email: tokenParsed.email || "",
      firstName: tokenParsed.given_name || "",
      lastName: tokenParsed.family_name || "",
      fullName: `${tokenParsed.given_name || ""} ${tokenParsed.family_name || ""}`.trim() || tokenParsed.preferred_username || "",
      roles: tokenParsed.realm_access?.roles || []
    };
  };
  const hasRole = (role) => {
    const userRoles = getUserInfo()?.roles || [];
    return userRoles.includes(role);
  };
  const hasAnyRole = (roles) => {
    const userRoles = getUserInfo()?.roles || [];
    return roles.some((role) => userRoles.includes(role));
  };
  watch([isAuthenticated, isInitialized], () => {
    if (isInitialized.value) {
      initializeUserData();
    }
  }, { immediate: true });
  nextTick(() => {
    if (isInitialized.value) {
      initializeUserData();
    }
  });
  return {
    isAuthenticated,
    user,
    token,
    refreshToken,
    isInitialized,
    initError,
    login,
    logout,
    register,
    getToken,
    refreshAuthToken,
    getUserInfo,
    hasRole,
    hasAnyRole,
    updateToken,
    isTokenExpired
  };
};

//# sourceMappingURL=data:application/json;base64,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QUVELFNBQU87QUFBQSxJQUNMO0FBQUEsSUFDQTtBQUFBLElBQ0E7QUFBQSxJQUNBO0FBQUEsSUFDQTtBQUFBLElBQ0E7QUFBQSxJQUNBO0FBQUEsSUFDQTtBQUFBLElBQ0E7QUFBQSxJQUNBO0FBQUEsSUFDQTtBQUFBLElBQ0E7QUFBQSxJQUNBO0FBQUEsSUFDQTtBQUFBLElBQ0E7QUFBQSxJQUNBO0FBQUEsRUFDRjtBQUNGIiwibmFtZXMiOltdLCJpZ25vcmVMaXN0IjpbXSwic291cmNlcyI6WyJ1c2VBdXRoLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImludGVyZmFjZSBVc2VySW5mbyB7XHJcbiAgaWQ6IHN0cmluZ1xyXG4gIHVzZXJuYW1lOiBzdHJpbmdcclxuICBlbWFpbDogc3RyaW5nXHJcbiAgZmlyc3ROYW1lOiBzdHJpbmdcclxuICBsYXN0TmFtZTogc3RyaW5nXHJcbiAgcm9sZXM6IHN0cmluZ1tdXHJcbiAgZnVsbE5hbWU6IHN0cmluZ1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgdXNlQXV0aCA9ICgpID0+IHtcclxuICBjb25zdCBudXh0QXBwID0gdXNlTnV4dEFwcCgpXHJcbiAgY29uc3QgeyBcclxuICAgIGdldFN0b3JlZEtleWNsb2FrRGF0YSwgXHJcbiAgICBjbGVhcktleWNsb2FrRGF0YSwgXHJcbiAgICBnZXRTdG9yZWRUb2tlbixcclxuICAgIHN0b3JlS2V5Y2xvYWtEYXRhLFxyXG4gICAgdXBkYXRlU3RvcmVkVG9rZW5zXHJcbiAgfSA9IHVzZUxvY2FsU3RvcmFnZSgpXHJcbiAgXHJcbiAgLy8gSGFuZGxlIGNhc2Ugd2hlcmUgS2V5Y2xvYWsgcGx1Z2luIGhhc24ndCBsb2FkZWQgeWV0XHJcbiAgY29uc3Qga2V5Y2xvYWsgPSBjb21wdXRlZCgoKSA9PiBudXh0QXBwLiRrZXljbG9haylcclxuICBjb25zdCBpc0F1dGhlbnRpY2F0ZWQgPSBjb21wdXRlZCgoKSA9PiBudXh0QXBwLiRpc0F1dGhlbnRpY2F0ZWQ/LnZhbHVlID8/IGZhbHNlKVxyXG4gIGNvbnN0IGlzSW5pdGlhbGl6ZWQgPSBjb21wdXRlZCgoKSA9PiBudXh0QXBwLiRpc0tleWNsb2FrSW5pdGlhbGl6ZWQ/LnZhbHVlID8/IGZhbHNlKVxyXG4gIGNvbnN0IGluaXRFcnJvciA9IGNvbXB1dGVkKCgpID0+IG51eHRBcHAuJGtleWNsb2FrSW5pdEVycm9yPy52YWx1ZSA/PyBudWxsKVxyXG4gIFxyXG4gIGNvbnN0IHVzZXIgPSByZWY8VXNlckluZm8gfCBudWxsPihudWxsKVxyXG4gIGNvbnN0IHRva2VuID0gcmVmPHN0cmluZyB8IG51bGw+KG51bGwpXHJcbiAgY29uc3QgcmVmcmVzaFRva2VuID0gcmVmPHN0cmluZyB8IG51bGw+KG51bGwpXHJcblxyXG4gIC8vIEluaXRpYWxpemUgdXNlciBkYXRhIGlmIGF1dGhlbnRpY2F0ZWRcclxuICBjb25zdCBpbml0aWFsaXplVXNlckRhdGEgPSAoKSA9PiB7XHJcbiAgICBjb25zdCBrZXljbG9ha0luc3RhbmNlID0ga2V5Y2xvYWsudmFsdWVcclxuICAgIGlmIChrZXljbG9ha0luc3RhbmNlICYmIGtleWNsb2FrSW5zdGFuY2UuYXV0aGVudGljYXRlZCkge1xyXG4gICAgICB1c2VyLnZhbHVlID0gZ2V0VXNlckluZm8oKVxyXG4gICAgICB0b2tlbi52YWx1ZSA9IGtleWNsb2FrSW5zdGFuY2UudG9rZW4gfHwgbnVsbFxyXG4gICAgICByZWZyZXNoVG9rZW4udmFsdWUgPSBrZXljbG9ha0luc3RhbmNlLnJlZnJlc2hUb2tlbiB8fCBudWxsXHJcbiAgICAgIFxyXG4gICAgICAvLyBTdG9yZSBpbiBsb2NhbFN0b3JhZ2VcclxuICAgICAgc3RvcmVLZXljbG9ha0RhdGEoa2V5Y2xvYWtJbnN0YW5jZSlcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIFRyeSB0byBsb2FkIGZyb20gbG9jYWxTdG9yYWdlIGlmIEtleWNsb2FrIGlzIG5vdCByZWFkeSB5ZXRcclxuICAgICAgY29uc3Qgc3RvcmVkRGF0YSA9IGdldFN0b3JlZEtleWNsb2FrRGF0YSgpXHJcbiAgICAgIGlmIChzdG9yZWREYXRhICYmIHN0b3JlZERhdGEuYXV0aGVudGljYXRlZCkge1xyXG4gICAgICAgIHVzZXIudmFsdWUgPSBzdG9yZWREYXRhLnVzZXJcclxuICAgICAgICB0b2tlbi52YWx1ZSA9IHN0b3JlZERhdGEudG9rZW5cclxuICAgICAgICByZWZyZXNoVG9rZW4udmFsdWUgPSBzdG9yZWREYXRhLnJlZnJlc2hUb2tlblxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHVzZXIudmFsdWUgPSBudWxsXHJcbiAgICAgICAgdG9rZW4udmFsdWUgPSBudWxsXHJcbiAgICAgICAgcmVmcmVzaFRva2VuLnZhbHVlID0gbnVsbFxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBBdXRoZW50aWNhdGlvbiBtZXRob2RzXHJcbiAgY29uc3QgbG9naW4gPSBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XHJcbiAgICBjb25zdCBrZXljbG9ha0luc3RhbmNlID0ga2V5Y2xvYWsudmFsdWVcclxuICAgIGlmICgha2V5Y2xvYWtJbnN0YW5jZSkgdGhyb3cgbmV3IEVycm9yKCdLZXljbG9hayBub3QgaW5pdGlhbGl6ZWQnKVxyXG4gICAgXHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCBrZXljbG9ha0luc3RhbmNlLmxvZ2luKHtcclxuICAgICAgICByZWRpcmVjdFVyaTogd2luZG93LmxvY2F0aW9uLm9yaWdpblxyXG4gICAgICB9KVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignTG9naW4gZmFpbGVkOicsIGVycm9yKVxyXG4gICAgICB0aHJvdyBlcnJvclxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY29uc3QgbG9nb3V0ID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgY29uc3Qga2V5Y2xvYWtJbnN0YW5jZSA9IGtleWNsb2FrLnZhbHVlXHJcbiAgICBpZiAoIWtleWNsb2FrSW5zdGFuY2UpIHRocm93IG5ldyBFcnJvcignS2V5Y2xvYWsgbm90IGluaXRpYWxpemVkJylcclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gQ2xlYXIgc2Vzc2lvbiBzdGF0ZSBiZWZvcmUgbG9nb3V0XHJcbiAgICAgIGNvbnN0IHsgY2xlYXJLZXljbG9ha1N0YXRlIH0gPSB1c2VLZXljbG9ha0d1YXJkKClcclxuICAgICAgY2xlYXJLZXljbG9ha1N0YXRlKClcclxuICAgICAgXHJcbiAgICAgIC8vIENsZWFyIGxvY2FsU3RvcmFnZSBkYXRhXHJcbiAgICAgIGNsZWFyS2V5Y2xvYWtEYXRhKClcclxuICAgICAgXHJcbiAgICAgIGF3YWl0IGtleWNsb2FrSW5zdGFuY2UubG9nb3V0KHtcclxuICAgICAgICByZWRpcmVjdFVyaTogd2luZG93LmxvY2F0aW9uLm9yaWdpblxyXG4gICAgICB9KVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignTG9nb3V0IGZhaWxlZDonLCBlcnJvcilcclxuICAgICAgdGhyb3cgZXJyb3JcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0IHJlZ2lzdGVyID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgY29uc3Qga2V5Y2xvYWtJbnN0YW5jZSA9IGtleWNsb2FrLnZhbHVlXHJcbiAgICBpZiAoIWtleWNsb2FrSW5zdGFuY2UpIHRocm93IG5ldyBFcnJvcignS2V5Y2xvYWsgbm90IGluaXRpYWxpemVkJylcclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQga2V5Y2xvYWtJbnN0YW5jZS5yZWdpc3Rlcih7XHJcbiAgICAgICAgcmVkaXJlY3RVcmk6IHdpbmRvdy5sb2NhdGlvbi5vcmlnaW5cclxuICAgICAgfSlcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1JlZ2lzdHJhdGlvbiBmYWlsZWQ6JywgZXJyb3IpXHJcbiAgICAgIHRocm93IGVycm9yXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCBnZXRUb2tlbiA9ICgpOiBzdHJpbmcgfCBudWxsID0+IHtcclxuICAgIC8vIFRyeSB0byBnZXQgdG9rZW4gZnJvbSBLZXljbG9hayBpbnN0YW5jZSBmaXJzdFxyXG4gICAgY29uc3Qga2V5Y2xvYWtUb2tlbiA9IGtleWNsb2FrLnZhbHVlPy50b2tlbiB8fCBudWxsXHJcbiAgICBpZiAoa2V5Y2xvYWtUb2tlbikgcmV0dXJuIGtleWNsb2FrVG9rZW5cclxuICAgIFxyXG4gICAgLy8gRmFsbGJhY2sgdG8gbG9jYWxTdG9yYWdlXHJcbiAgICByZXR1cm4gZ2V0U3RvcmVkVG9rZW4oKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgcmVmcmVzaEF1dGhUb2tlbiA9IGFzeW5jICgpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+ID0+IHtcclxuICAgIGNvbnN0IGtleWNsb2FrSW5zdGFuY2UgPSBrZXljbG9hay52YWx1ZVxyXG4gICAgaWYgKCFrZXljbG9ha0luc3RhbmNlKSByZXR1cm4gbnVsbFxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJlZnJlc2hlZCA9IGF3YWl0IGtleWNsb2FrSW5zdGFuY2UudXBkYXRlVG9rZW4oMzApXHJcbiAgICAgIGlmIChyZWZyZXNoZWQpIHtcclxuICAgICAgICB0b2tlbi52YWx1ZSA9IGtleWNsb2FrSW5zdGFuY2UudG9rZW4gfHwgbnVsbFxyXG4gICAgICAgIHJlZnJlc2hUb2tlbi52YWx1ZSA9IGtleWNsb2FrSW5zdGFuY2UucmVmcmVzaFRva2VuIHx8IG51bGxcclxuICAgICAgICBcclxuICAgICAgICAvLyBVcGRhdGUgbG9jYWxTdG9yYWdlIHdpdGggbmV3IHRva2Vuc1xyXG4gICAgICAgIGNvbnN0IGV4cGlyZXNBdCA9IGtleWNsb2FrSW5zdGFuY2UudG9rZW5QYXJzZWQ/LmV4cCA/IGtleWNsb2FrSW5zdGFuY2UudG9rZW5QYXJzZWQuZXhwICogMTAwMCA6IG51bGxcclxuICAgICAgICB1cGRhdGVTdG9yZWRUb2tlbnMoXHJcbiAgICAgICAgICBrZXljbG9ha0luc3RhbmNlLnRva2VuIHx8IG51bGwsXHJcbiAgICAgICAgICBrZXljbG9ha0luc3RhbmNlLnJlZnJlc2hUb2tlbiB8fCBudWxsLFxyXG4gICAgICAgICAga2V5Y2xvYWtJbnN0YW5jZS5pZFRva2VuIHx8IG51bGwsXHJcbiAgICAgICAgICBleHBpcmVzQXRcclxuICAgICAgICApXHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc29sZS5sb2coJ1Rva2VuIHJlZnJlc2hlZCBzdWNjZXNzZnVsbHknKVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBrZXljbG9ha0luc3RhbmNlLnRva2VuIHx8IG51bGxcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1Rva2VuIHJlZnJlc2ggZmFpbGVkOicsIGVycm9yKVxyXG4gICAgICBjbGVhcktleWNsb2FrRGF0YSgpXHJcbiAgICAgIGF3YWl0IGxvZ291dCgpXHJcbiAgICAgIHJldHVybiBudWxsXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCB1cGRhdGVUb2tlbiA9IGFzeW5jIChtaW5WYWxpZGl0eTogbnVtYmVyID0gMzApOiBQcm9taXNlPGJvb2xlYW4+ID0+IHtcclxuICAgIGNvbnN0IGtleWNsb2FrSW5zdGFuY2UgPSBrZXljbG9hay52YWx1ZVxyXG4gICAgaWYgKCFrZXljbG9ha0luc3RhbmNlKSByZXR1cm4gZmFsc2VcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCByZWZyZXNoZWQgPSBhd2FpdCBrZXljbG9ha0luc3RhbmNlLnVwZGF0ZVRva2VuKG1pblZhbGlkaXR5KVxyXG4gICAgICBpZiAocmVmcmVzaGVkKSB7XHJcbiAgICAgICAgdG9rZW4udmFsdWUgPSBrZXljbG9ha0luc3RhbmNlLnRva2VuIHx8IG51bGxcclxuICAgICAgICByZWZyZXNoVG9rZW4udmFsdWUgPSBrZXljbG9ha0luc3RhbmNlLnJlZnJlc2hUb2tlbiB8fCBudWxsXHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gVXBkYXRlIGxvY2FsU3RvcmFnZSB3aXRoIG5ldyB0b2tlbnNcclxuICAgICAgICBjb25zdCBleHBpcmVzQXQgPSBrZXljbG9ha0luc3RhbmNlLnRva2VuUGFyc2VkPy5leHAgPyBrZXljbG9ha0luc3RhbmNlLnRva2VuUGFyc2VkLmV4cCAqIDEwMDAgOiBudWxsXHJcbiAgICAgICAgdXBkYXRlU3RvcmVkVG9rZW5zKFxyXG4gICAgICAgICAga2V5Y2xvYWtJbnN0YW5jZS50b2tlbiB8fCBudWxsLFxyXG4gICAgICAgICAga2V5Y2xvYWtJbnN0YW5jZS5yZWZyZXNoVG9rZW4gfHwgbnVsbCxcclxuICAgICAgICAgIGtleWNsb2FrSW5zdGFuY2UuaWRUb2tlbiB8fCBudWxsLFxyXG4gICAgICAgICAgZXhwaXJlc0F0XHJcbiAgICAgICAgKVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiByZWZyZXNoZWRcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byB1cGRhdGUgdG9rZW46JywgZXJyb3IpXHJcbiAgICAgIGNsZWFyS2V5Y2xvYWtEYXRhKClcclxuICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCBpc1Rva2VuRXhwaXJlZCA9ICgpOiBib29sZWFuID0+IHtcclxuICAgIGNvbnN0IGtleWNsb2FrSW5zdGFuY2UgPSBrZXljbG9hay52YWx1ZVxyXG4gICAgaWYgKCFrZXljbG9ha0luc3RhbmNlIHx8ICFrZXljbG9ha0luc3RhbmNlLnRva2VuKSByZXR1cm4gdHJ1ZVxyXG4gICAgcmV0dXJuIGtleWNsb2FrSW5zdGFuY2UuaXNUb2tlbkV4cGlyZWQoKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgZ2V0VXNlckluZm8gPSAoKTogVXNlckluZm8gfCBudWxsID0+IHtcclxuICAgIGNvbnN0IGtleWNsb2FrSW5zdGFuY2UgPSBrZXljbG9hay52YWx1ZVxyXG4gICAgaWYgKCFrZXljbG9ha0luc3RhbmNlPy50b2tlblBhcnNlZCkgcmV0dXJuIG51bGxcclxuXHJcbiAgICBjb25zdCB0b2tlblBhcnNlZCA9IGtleWNsb2FrSW5zdGFuY2UudG9rZW5QYXJzZWRcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGlkOiB0b2tlblBhcnNlZC5zdWIgfHwgJycsXHJcbiAgICAgIHVzZXJuYW1lOiB0b2tlblBhcnNlZC5wcmVmZXJyZWRfdXNlcm5hbWUgfHwgJycsXHJcbiAgICAgIGVtYWlsOiB0b2tlblBhcnNlZC5lbWFpbCB8fCAnJyxcclxuICAgICAgZmlyc3ROYW1lOiB0b2tlblBhcnNlZC5naXZlbl9uYW1lIHx8ICcnLFxyXG4gICAgICBsYXN0TmFtZTogdG9rZW5QYXJzZWQuZmFtaWx5X25hbWUgfHwgJycsXHJcbiAgICAgIGZ1bGxOYW1lOiBgJHt0b2tlblBhcnNlZC5naXZlbl9uYW1lIHx8ICcnfSAke3Rva2VuUGFyc2VkLmZhbWlseV9uYW1lIHx8ICcnfWAudHJpbSgpIHx8IHRva2VuUGFyc2VkLnByZWZlcnJlZF91c2VybmFtZSB8fCAnJyxcclxuICAgICAgcm9sZXM6IHRva2VuUGFyc2VkLnJlYWxtX2FjY2Vzcz8ucm9sZXMgfHwgW11cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0IGhhc1JvbGUgPSAocm9sZTogc3RyaW5nKTogYm9vbGVhbiA9PiB7XHJcbiAgICBjb25zdCB1c2VyUm9sZXMgPSBnZXRVc2VySW5mbygpPy5yb2xlcyB8fCBbXVxyXG4gICAgcmV0dXJuIHVzZXJSb2xlcy5pbmNsdWRlcyhyb2xlKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgaGFzQW55Um9sZSA9IChyb2xlczogc3RyaW5nW10pOiBib29sZWFuID0+IHtcclxuICAgIGNvbnN0IHVzZXJSb2xlcyA9IGdldFVzZXJJbmZvKCk/LnJvbGVzIHx8IFtdXHJcbiAgICByZXR1cm4gcm9sZXMuc29tZShyb2xlID0+IHVzZXJSb2xlcy5pbmNsdWRlcyhyb2xlKSlcclxuICB9XHJcblxyXG4gIC8vIFdhdGNoIGZvciBhdXRoZW50aWNhdGlvbiBjaGFuZ2VzXHJcbiAgd2F0Y2goW2lzQXV0aGVudGljYXRlZCwgaXNJbml0aWFsaXplZF0sICgpID0+IHtcclxuICAgIGlmIChpc0luaXRpYWxpemVkLnZhbHVlKSB7XHJcbiAgICAgIGluaXRpYWxpemVVc2VyRGF0YSgpXHJcbiAgICB9XHJcbiAgfSwgeyBpbW1lZGlhdGU6IHRydWUgfSlcclxuXHJcbiAgLy8gSW5pdGlhbGl6ZSB1c2VyIGRhdGEgb24gZmlyc3QgbG9hZFxyXG4gIG5leHRUaWNrKCgpID0+IHtcclxuICAgIGlmIChpc0luaXRpYWxpemVkLnZhbHVlKSB7XHJcbiAgICAgIGluaXRpYWxpemVVc2VyRGF0YSgpXHJcbiAgICB9XHJcbiAgfSlcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIGlzQXV0aGVudGljYXRlZCxcclxuICAgIHVzZXIsXHJcbiAgICB0b2tlbixcclxuICAgIHJlZnJlc2hUb2tlbixcclxuICAgIGlzSW5pdGlhbGl6ZWQsXHJcbiAgICBpbml0RXJyb3IsXHJcbiAgICBsb2dpbixcclxuICAgIGxvZ291dCxcclxuICAgIHJlZ2lzdGVyLFxyXG4gICAgZ2V0VG9rZW4sXHJcbiAgICByZWZyZXNoQXV0aFRva2VuLFxyXG4gICAgZ2V0VXNlckluZm8sXHJcbiAgICBoYXNSb2xlLFxyXG4gICAgaGFzQW55Um9sZSxcclxuICAgIHVwZGF0ZVRva2VuLFxyXG4gICAgaXNUb2tlbkV4cGlyZWRcclxuICB9XHJcbn1cclxuIl0sImZpbGUiOiJEOi9CaWxsMjQvYjI0bWFuYWdlbWVudHBvcnRhbC9hcHAvY29tcG9zYWJsZXMvdXNlQXV0aC50cyJ9